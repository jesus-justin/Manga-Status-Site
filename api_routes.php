<?php
/**\n * API Routes Configuration\n * \n * Defines all REST API endpoints with proper request handling.\n */\n\nrequire_once 'config/constants.php';\nrequire_once 'src/Router.php';\nrequire_once 'src/Response.php';\nrequire_once 'src/Sanitizer.php';\nrequire_once 'src/Auth.php';\nrequire_once 'src/DB.php';\n\n$router = new Router();\n$auth = new Auth($conn);\n$db = new DB($conn);\n$sanitizer = new Sanitizer();\n\n// Get current user profile\n$router->get('/api/user/profile', function($params) use ($auth, $db) {\n    if (!$auth->requireLogin()) {\n        return Response::error('Unauthorized', 401);\n    }\n    \n    $user_id = $_SESSION['user_id'];\n    $user = $db->getRow(\n        \"SELECT id, username, email FROM users WHERE id = ?\",\n        \"i\",\n        $user_id\n    );\n    \n    return Response::json($user);\n});\n\n// Get user manga collection\n$router->get('/api/user/collection', function($params) use ($auth, $db) {\n    if (!$auth->requireLogin()) {\n        return Response::error('Unauthorized', 401);\n    }\n    \n    $user_id = $_SESSION['user_id'];\n    $manga = $db->getRows(\n        \"SELECT * FROM user_reading_progress WHERE user_id = ? ORDER BY id DESC\",\n        \"i\",\n        $user_id\n    );\n    \n    return Response::json($manga);\n});\n\n// Get manga by ID\n$router->get('/api/manga/:id', function($params) use ($db) {\n    $manga = $db->getRow(\n        \"SELECT * FROM manga WHERE id = ?\",\n        \"i\",\n        (int)$params['id']\n    );\n    \n    if (!$manga) {\n        return Response::error('Manga not found', 404);\n    }\n    \n    return Response::json($manga);\n});\n\n// Search manga\n$router->get('/api/manga/search/:query', function($params) use ($db) {\n    $query = $db->escape($params['query']);\n    $results = $db->getRows(\n        \"SELECT * FROM manga WHERE LOWER(title) LIKE LOWER(?)\",\n        \"s\",\n        \"%$query%\"\n    );\n    \n    return Response::json($results);\n});\n\n// Update reading progress\n$router->post('/api/progress/update', function($params) use ($auth, $db, $sanitizer) {\n    if (!$auth->requireLogin()) {\n        return Response::error('Unauthorized', 401);\n    }\n    \n    $input = json_decode(file_get_contents('php://input'), true);\n    \n    $user_id = $_SESSION['user_id'];\n    $manga_id = (int)($input['manga_id'] ?? 0);\n    $status = $sanitizer->string($input['status'] ?? '');\n    $rating = (int)($input['rating'] ?? 0);\n    $chapters = (int)($input['chapters'] ?? 0);\n    \n    if ($manga_id <= 0) {\n        return Response::error('Invalid manga ID', 400);\n    }\n    \n    $result = $db->query(\n        \"UPDATE user_reading_progress SET status = ?, rating = ?, chapters = ?, updated_at = NOW() WHERE user_id = ? AND manga_id = ?\",\n        \"siii\",\n        $status,\n        $rating,\n        $chapters,\n        $user_id,\n        $manga_id\n    );\n    \n    return Response::json(['success' => true, 'message' => 'Progress updated']);\n});\n\n// Delete from collection\n$router->delete('/api/progress/delete/:manga_id', function($params) use ($auth, $db) {\n    if (!$auth->requireLogin()) {\n        return Response::error('Unauthorized', 401);\n    }\n    \n    $user_id = $_SESSION['user_id'];\n    $manga_id = (int)$params['manga_id'];\n    \n    $db->query(\n        \"DELETE FROM user_reading_progress WHERE user_id = ? AND manga_id = ?\",\n        \"ii\",\n        $user_id,\n        $manga_id\n    );\n    \n    return Response::json(['success' => true, 'message' => 'Removed from collection']);\n});\n\n// Get user stats\n$router->get('/api/user/stats', function($params) use ($auth, $db) {\n    if (!$auth->requireLogin()) {\n        return Response::error('Unauthorized', 401);\n    }\n    \n    $user_id = $_SESSION['user_id'];\n    \n    $stats = [\n        'total_manga' => $db->getValue(\n            \"SELECT COUNT(*) FROM user_reading_progress WHERE user_id = ?\",\n            \"i\",\n            $user_id\n        ),\n        'reading' => $db->getValue(\n            \"SELECT COUNT(*) FROM user_reading_progress WHERE user_id = ? AND status = 'currently reading'\",\n            \"i\",\n            $user_id\n        ),\n        'completed' => $db->getValue(\n            \"SELECT COUNT(*) FROM user_reading_progress WHERE user_id = ? AND status = 'finished'\",\n            \"i\",\n            $user_id\n        ),\n        'will_read' => $db->getValue(\n            \"SELECT COUNT(*) FROM user_reading_progress WHERE user_id = ? AND status = 'will read'\",\n            \"i\",\n            $user_id\n        )\n    ];\n    \n    return Response::json($stats);\n});\n\n// Determine request method and URI\n$method = $_SERVER['REQUEST_METHOD'];\n$uri = $_SERVER['REQUEST_URI'];\n\n// Dispatch and send response\nheader('Content-Type: application/json');\n$result = $router->dispatch($method, $uri);\n\nif (is_array($result)) {\n    http_response_code($result['status'] ?? 200);\n    echo json_encode($result);\n} else {\n    http_response_code(500);\n    echo json_encode(['success' => false, 'error' => 'Unknown error']);\n}\n\n?>\n"